import os
import logging
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
from telegram import InputFile
from docx import Document
from pydub import AudioSegment
import openai

# Ø£Ø®Ø° Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Environment Variables
TOKEN = os.getenv("TOKEN")
openai.api_key = os.getenv("OPENAI_API_KEY")

logging.basicConfig(level=logging.INFO)

def start(update, context):
    update.message.reply_text("ğŸ‘‹ Ø§Ù‡Ù„Ø§! Ø§Ø±Ø³Ù„ Ù…Ù„Ù ØµÙˆØªÙŠ Ø£Ùˆ ÙÙˆÙŠØ³ Ø­ØªÙ‰ Ø§Ø­ÙˆÙ„Ù‡ Ø¥Ù„Ù‰ Ù†Øµ Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Word.")

def voice_handler(update, context):
    file = update.message.voice or update.message.audio
    if not file:
        update.message.reply_text("âŒ Ù„Ø§Ø²Ù… ØªØ±Ø³Ù„ Ù…Ù„Ù ØµÙˆØªÙŠ.")
        return

    file_path = file.get_file().download("input.ogg")

    # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ mp3
    sound = AudioSegment.from_file("input.ogg")
    sound.export("input.mp3", format="mp3")

    # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Whisper
    with open("input.mp3", "rb") as audio_file:
        transcript = openai.Audio.transcriptions.create(
            model="whisper-1",
            file=audio_file,
            response_format="text",
            language="ar"
        )

    text = transcript.strip()

    # Ø­ÙØ¸ Ø§Ù„Ù†Øµ ÙÙŠ Word
    doc = Document()
    doc.add_paragraph(text)
    output_path = "output.docx"
    doc.save(output_path)

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
    with open(output_path, "rb") as f:
        update.message.reply_document(document=InputFile(f, filename="transcribed.docx"),
                                      caption="âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ Word")

def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.voice | Filters.audio, voice_handler))
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
